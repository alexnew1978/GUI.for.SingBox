name: Build OpenWrt aarch64 Package

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  Build-OpenWrt:
    runs-on: ubuntu-latest
    env:
      APP_NAME: GUI.for.SingBox
    steps:
      # Шаг 1: Клонируем репозиторий с исходниками
      - name: Checkout repository
        uses: actions/checkout@v4

      # Шаг 2: Установка необходимых зависимостей
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget build-essential libncurses5-dev libssl-dev gettext gcc g++ unzip zstd

      # Шаг 3: Скачиваем SDK для OpenWrt rockchip/armv8
      - name: Download OpenWrt SDK for rockchip/armv8
        run: |
          wget https://downloads.openwrt.org/releases/24.10.0/targets/rockchip/armv8/openwrt-sdk-24.10.0-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          tar -I zstd -xvf openwrt-sdk-24.10.0-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          export SDK_PATH=$(pwd)/openwrt-sdk-24.10.0-rockchip-armv8*/staging_dir/toolchain-rockchip_armv8_gcc-13.3.0_musl/bin
          export PATH=$SDK_PATH:$PATH
          echo "SDK_PATH set to: $SDK_PATH"

      # Шаг 4: Обновление фидов и установка зависимостей OpenWrt
      - name: Update feeds and install dependencies
        run: |
          ./openwrt-sdk-24.10.0-rockchip-armv8*/scripts/feeds update -a
          ./openwrt-sdk-24.10.0-rockchip-armv8*/scripts/feeds install -a

      # Шаг 5: Создание конфигурации OpenWrt
      - name: Create OpenWrt configuration
        run: |
          make defconfig
          cat .config

      # Шаг 6: Сборка пакета для rockchip/armv8
      - name: Build OpenWrt package for rockchip/armv8
        run: |
          make package/feeds/packages/your-package
          if [ $? -ne 0 ]; then
            echo "Build failed!" && exit 1
          fi

      # Шаг 7: Упаковка .ipk файла
      - name: Package OpenWrt build for rockchip/armv8
        run: |
          cp -r ./build_dir/target-rockchip_armv8*/your-package.ipk ./build/
          zip -r your-package-rockchip-armv8-openwrt.zip ./build/your-package.ipk

      # Шаг 8: Загрузка артефактов
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rockchip-armv8-builds
          path: build/your-package-rockchip-armv8-openwrt.zip


