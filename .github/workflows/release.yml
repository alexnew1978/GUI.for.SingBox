jobs:
  Build-OpenWrt:
    runs-on: ubuntu-latest
    env:
      APP_NAME: GUI.for.SingBox
    steps:
      # Шаг 1: Клонируем репозиторий с исходниками
      - uses: actions/checkout@v4

      # Шаг 2: Скачиваем OpenWrt SDK для aarch64
      - name: Download OpenWrt SDK for aarch64
        run: |
          wget https://downloads.openwrt.org/snapshots/targets/armvirt/64/openwrt-sdk-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          tar -xvf openwrt-sdk-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          export PATH=$PWD/openwrt-sdk-armvirt-64*/staging_dir/toolchain-arm_cortex-a53_gcc-8.4.0_musl/bin:$PATH

      # Шаг 3: Настроим OpenWrt build system
      - name: Set up OpenWrt build system
        run: |
          ./openwrt-sdk-armvirt-64*/scripts/feeds update -a
          ./openwrt-sdk-armvirt-64*/scripts/feeds install -a
          make menuconfig
          
      # Шаг 4: Сборка пакета для aarch64
      - name: Build OpenWrt package for aarch64
        run: |
          make package/feeds/packages/your-package

      # Шаг 5: Упаковка в .ipk и создание архива
      - name: Package OpenWrt build for aarch64
        run: |
          cp -r ./build_dir/target-arm_cortex-a53*/your-package.ipk ./build/
          zip -r your-package-aarch64-openwrt.zip ./build/your-package.ipk

      # Шаг 6: Загрузка артефакта (собранного пакета)
      - uses: actions/upload-artifact@v4
        with:
          name: openwrt-aarch64-builds
          path: build/your-package-aarch64-openwrt.zip
